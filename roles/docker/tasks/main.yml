- name: check if docker repository is already added
  ansible.builtin.shell: dnf repolist -v | grep -q docker-ce-stable
  register: docker_repo_check
  changed_when: false
  failed_when: false

- name: add docker repository
  ansible.builtin.command: dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
  when: docker_repo_check.rc != 0

- name: enable docker repository
  community.general.dnf_config_manager:
    name: docker-ce-stable
    state: enabled

- name: install docker
  ansible.builtin.dnf:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: latest

- name: start docker service
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes

- name: add BTRFS subvolume for Nginx Proxy Manager
  community.general.btrfs_subvolume:
    name: /nginx-proxy-manager
    state: present
    filesystem_label: "{{ nvme_filesystem_label }}"

- name: deploy Nginx Proxy Manager
  community.docker.docker_container:
    name: nginx-proxy-manager
    image: jc21/nginx-proxy-manager:latest
    restart_policy: unless-stopped
    volumes:
      - "{{ nvme_mount_point }}/nginx-proxy-manager/data:/data"
      - "{{ nvme_mount_point }}/nginx-proxy-manager/etc/letsencrypt:/etc/letsencrypt"
    ports:
      - "80:80"
      - "81:81"
      - "443:443"

- name: add BTRFS subvolumes for Komga 
  community.general.btrfs_subvolume:
    name: /komga
    state: present
    filesystem_label: "{{ item }}"
  with_items:
    - "{{ nvme_filesystem_label }}"
    - "{{ hdd_filesystem_label }}"

- name: deploy Komga
  community.docker.docker_container:
    name: komga
    image: gotson/komga:latest
    restart_policy: unless-stopped
    volumes:
      - "{{ nvme_mount_point }}/komga/config:/config"
      - "{{ hdd_mount_point }}/komga/data:/data"
    ports:
      - "25600:25600"
    # user: "1000:1000"
    env:
      TZ: "Europe/Berlin"

- name: add BTRFS subvolume for Syncthing
  community.general.btrfs_subvolume:
    name: /syncthing
    state: present
    filesystem_label: "{{ nvme_filesystem_label }}"

- name: open Syncthing ports
  ansible.builtin.firewalld:
    port: 8384/tcp
    permanent: yes
    state: enabled
    immediate: true

- name: deploy Syncthing
  community.docker.docker_container:
    name: syncthing
    image: syncthing/syncthing:latest
    restart_policy: unless-stopped
    volumes:
      - "{{ nvme_mount_point }}/syncthing/st-sync:/var/syncthing"
    # user: "1000:1000"
    network_mode: host

- name: add BTRFS subvolume for Actual Budget
  community.general.btrfs_subvolume:
    name: /actual-budget
    state: present
    filesystem_label: "{{ item }}"
  with_items:
    - "{{ nvme_filesystem_label }}"
    - "{{ hdd_filesystem_label }}"

- name: deploy Actual Budget
  community.docker.docker_container:
    name: actual-budget
    image: actualbudget/actual-server:latest
    restart_policy: unless-stopped
    volumes:
      - "{{ hdd_mount_point }}/actual-budget/data:/data"
    ports:
      - "5006:5006"

- name: add BTRFS subvolume for Immich
  community.general.btrfs_subvolume:
    name: /immich
    state: present
    filesystem_label: "{{ item }}"
  with_items:
    - "{{ nvme_filesystem_label }}"
    - "{{ hdd_filesystem_label }}"

# - name: deploy Immich
#   community.docker.docker_container:
#     name: immich
#     image: immich/immich:latest
#     restart_policy: unless-stopped
#     volumes:
#       - "{{ hdd_mount_point }}/immich/data:/data"
#     ports:
#       - "5005:5005"
#     env:
#       TZ: "Europe/Berlin"